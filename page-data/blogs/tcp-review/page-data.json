{"componentChunkName":"component---src-templates-blog-post-js","path":"/blogs/tcp-review/","result":{"data":{"site":{"siteMetadata":{"title":"Chenxiao's Blog","author":"Chenxiao Guan"}},"markdownRemark":{"id":"77785995-2be2-5bba-aba6-2d94e40805be","excerpt":"001. 能不能说一说 TCP 和 UDP 的区别？ 首先概括一下基本的区别: TCP是一个面向连接的、可靠的、基于字节流的传输层协议。 而UDP是一个面向无连接的传输层协议。(就这么简单，其它TCP的特性也就没有了)。 具体来分析，和 UDP 相比，TCP…","html":"<h1 id=\"001-能不能说一说-tcp-和-udp-的区别？\" style=\"position:relative;\"><a href=\"#001-%E8%83%BD%E4%B8%8D%E8%83%BD%E8%AF%B4%E4%B8%80%E8%AF%B4-tcp-%E5%92%8C-udp-%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9F\" aria-label=\"001 能不能说一说 tcp 和 udp 的区别？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>001. 能不能说一说 TCP 和 UDP 的区别？</h1>\n<p>首先概括一下基本的区别:</p>\n<p>TCP是一个面向连接的、可靠的、基于字节流的传输层协议。</p>\n<p>而UDP是一个面向无连接的传输层协议。(就这么简单，其它TCP的特性也就没有了)。</p>\n<p>具体来分析，和 UDP 相比，TCP 有三大核心特性:</p>\n<p>面向连接。所谓的连接，指的是客户端和服务器的连接，在双方互相通信之前，TCP 需要三次握手建立连接，而 UDP 没有相应建立连接的过程。</p>\n<p>可靠性。TCP 花了非常多的功夫保证连接的可靠，这个可靠性体现在哪些方面呢？一个是有状态，另一个是可控制。</p>\n<p>TCP 会精准记录哪些数据发送了，哪些数据被对方接收了，哪些没有被接收到，而且保证数据包按序到达，不允许半点差错。这是有状态。</p>\n<p>当意识到丢包了或者网络环境不佳，TCP 会根据具体情况调整自己的行为，控制自己的发送速度或者重发。这是可控制。</p>\n<p>相应的，UDP 就是无状态, 不可控的。</p>\n<p>面向字节流。UDP 的数据传输是基于数据报的，这是因为仅仅只是继承了 IP 层的特性，而 TCP 为了维护状态，将一个个 IP 包变成了字节流。</p>\n<h1 id=\"说说-tcp-三次握手的过程？为什么是三次而不是两次、四次？\" style=\"position:relative;\"><a href=\"#%E8%AF%B4%E8%AF%B4-tcp-%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E7%9A%84%E8%BF%87%E7%A8%8B%EF%BC%9F%E4%B8%BA%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%89%E6%AC%A1%E8%80%8C%E4%B8%8D%E6%98%AF%E4%B8%A4%E6%AC%A1%E3%80%81%E5%9B%9B%E6%AC%A1%EF%BC%9F\" aria-label=\"说说 tcp 三次握手的过程？为什么是三次而不是两次、四次？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>说说 TCP 三次握手的过程？为什么是三次而不是两次、四次？</h1>\n<h2 id=\"恋爱模拟\" style=\"position:relative;\"><a href=\"#%E6%81%8B%E7%88%B1%E6%A8%A1%E6%8B%9F\" aria-label=\"恋爱模拟 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>恋爱模拟</h2>\n<p>以谈恋爱为例，两个人能够在一起最重要的事情是首先确认各自爱和被爱的能力。接下来我们以此来模拟三次握手的过程。</p>\n<p>第一次:</p>\n<p>男: <strong>我爱你。</strong></p>\n<p>女方收到。</p>\n<p>由此证明男方拥有<code class=\"language-text\">爱</code>的能力。</p>\n<p>第二次:</p>\n<p>女: <strong>我收到了你的爱，我也爱你。</strong></p>\n<p>男方收到。</p>\n<p>OK，现在的情况说明，女方拥有<strong>爱</strong>和<strong>被爱</strong>的能力。</p>\n<p>第三次:</p>\n<p>男: <strong>我收到了你的爱。</strong></p>\n<p>女方收到。</p>\n<p>现在能够保证男方具备<strong>被爱</strong>的能力。</p>\n<p>由此完整地确认了双方<strong>爱</strong>和<strong>被爱</strong>的能力，两人开始一段甜蜜的爱情。</p>\n<h2 id=\"真实握手\" style=\"position:relative;\"><a href=\"#%E7%9C%9F%E5%AE%9E%E6%8F%A1%E6%89%8B\" aria-label=\"真实握手 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>真实握手</h2>\n<p>当然刚刚那段属于扯淡，不代表本人价值观，目的是让大家理解整个握手过程的意义，因为两个过程非常相似。对应到 TCP 的三次握手，也是需要确认双方的两样能力: <strong>发送的能力</strong>和<strong>接收的能力</strong>。于是便会有下面的三次握手的过程:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 529px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/666d7d20aa907d8317af3770411f5aa2/62e42/tcp1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAQAF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3EQqP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABkQAAIDAQAAAAAAAAAAAAAAAAARARAhMf/aAAgBAQABPyHmsco2pr//2gAMAwEAAgADAAAAEOAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAICAwEAAAAAAAAAAAAAAQARIUExUXGB/9oACAEBAAE/ELKJcxTDe4g2y8nsGPvREn//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"three-way-handshake-pic\"\n        title=\"three-way-handshake-pic\"\n        src=\"/static/666d7d20aa907d8317af3770411f5aa2/62e42/tcp1.jpg\"\n        srcset=\"/static/666d7d20aa907d8317af3770411f5aa2/a80bd/tcp1.jpg 148w,\n/static/666d7d20aa907d8317af3770411f5aa2/1c91a/tcp1.jpg 295w,\n/static/666d7d20aa907d8317af3770411f5aa2/62e42/tcp1.jpg 529w\"\n        sizes=\"(max-width: 529px) 100vw, 529px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>从最开始双方都处于<code class=\"language-text\">CLOSED</code>状态。然后服务端开始监听某个端口，进入了<code class=\"language-text\">LISTEN</code>状态。</p>\n<p>然后客户端主动发起连接，发送 <code class=\"language-text\">SYN</code> , 自己变成了<code class=\"language-text\">SYN-SENT</code>状态。</p>\n<p>服务端接收到，返回<code class=\"language-text\">SYN</code>和<code class=\"language-text\">ACK</code>(对应客户端发来的<code class=\"language-text\">SYN</code>)，自己变成了<code class=\"language-text\">SYN-RCVD</code>。</p>\n<p>之后客户端再发送<code class=\"language-text\">ACK</code>给服务端，自己变成了<code class=\"language-text\">ESTABLISHED</code>状态；服务端收到<code class=\"language-text\">ACK</code>之后，也变成了<code class=\"language-text\">ESTABLISHED</code>状态。</p>\n<p>另外需要提醒你注意的是，从图中可以看出，<code class=\"language-text\">SYN</code>是需要消耗一个序列号的，下次发送对应的<code class=\"language-text\">ACK</code>序列号要加1，为什么呢？只需要记住一个规则:</p>\n<blockquote>\n<p>凡是需要对端确认的，一定消耗TCP报文的序列号。</p>\n</blockquote>\n<p>SYN 需要对端的确认， 而 ACK 并不需要，因此 SYN 消耗一个序列号而 ACK 不需要。</p>\n<h2 id=\"为什么不是两次？\" style=\"position:relative;\"><a href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E6%98%AF%E4%B8%A4%E6%AC%A1%EF%BC%9F\" aria-label=\"为什么不是两次？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>为什么不是两次？</h2>\n<p>根本原因: 无法确认客户端的接收能力。</p>\n<p>分析如下:</p>\n<p>如果是两次，你现在发了 SYN 报文想握手，但是这个包滞留在了当前的网络中迟迟没有到达，TCP 以为这是丢了包，于是重传，两次握手建立好了连接。</p>\n<p>看似没有问题，但是连接关闭后，如果这个滞留在网路中的包到达了服务端呢？这时候由于是两次握手，服务端只要接收到然后发送相应的数据包，就默认建立连接，但是现在客户端已经断开了。</p>\n<p>看到问题的吧，这就带来了连接资源的浪费。</p>\n<h2 id=\"为什么不是四次？\" style=\"position:relative;\"><a href=\"#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%8D%E6%98%AF%E5%9B%9B%E6%AC%A1%EF%BC%9F\" aria-label=\"为什么不是四次？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>为什么不是四次？</h2>\n<p>三次握手的目的是确认双方<code class=\"language-text\">发送</code>和<code class=\"language-text\">接收</code>的能力，那四次握手可以嘛？</p>\n<p>当然可以，100 次都可以。但为了解决问题，三次就足够了，再多用处就不大了。</p>\n<h2 id=\"三次握手过程中可以携带数据么？\" style=\"position:relative;\"><a href=\"#%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E8%BF%87%E7%A8%8B%E4%B8%AD%E5%8F%AF%E4%BB%A5%E6%90%BA%E5%B8%A6%E6%95%B0%E6%8D%AE%E4%B9%88%EF%BC%9F\" aria-label=\"三次握手过程中可以携带数据么？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>三次握手过程中可以携带数据么？</h2>\n<p>第三次握手的时候，可以携带。前两次握手不能携带数据。</p>\n<p>如果前两次握手能够携带数据，那么一旦有人想攻击服务器，那么他只需要在第一次握手中的 SYN 报文中放大量数据，那么服务器势必会消耗更多的时间和内存空间去处理这些数据，增大了服务器被攻击的风险。</p>\n<p>第三次握手的时候，客户端已经处于<code class=\"language-text\">ESTABLISHED</code>状态，并且已经能够确认服务器的接收、发送能力正常，这个时候相对安全了，可以携带数据。</p>\n<h2 id=\"同时打开会怎样？\" style=\"position:relative;\"><a href=\"#%E5%90%8C%E6%97%B6%E6%89%93%E5%BC%80%E4%BC%9A%E6%80%8E%E6%A0%B7%EF%BC%9F\" aria-label=\"同时打开会怎样？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>同时打开会怎样？</h2>\n<p>如果双方同时发 <code class=\"language-text\">SYN</code>报文，状态变化会是怎样的呢？</p>\n<p>这是一个可能会发生的情况。</p>\n<p>状态变迁如下:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8de795e097623b8d278ca45ee3184480/9c477/tcp2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 87.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3bBQUAH/xAAWEAEBAQAAAAAAAAAAAAAAAAABECD/2gAIAQEAAQUChTH/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AR//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AR//xAAUEAEAAAAAAAAAAAAAAAAAAAAw/9oACAEBAAY/Ah//xAAcEAABBAMBAAAAAAAAAAAAAAAAAREhQRAxUeH/2gAIAQEAAT8heR+CoJeyU8NLFoWsf//aAAwDAQACAAMAAAAQgwA8/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHRAAAgMAAgMAAAAAAAAAAAAAAREAITFRcRCRwf/aAAgBAQABPxB3t3ghfVcxmnDZyNQAgYAhte012mu3zx//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"handshake-initiated-simultaneously\"\n        title=\"handshake-initiated-simultaneously\"\n        src=\"/static/8de795e097623b8d278ca45ee3184480/1c72d/tcp2.jpg\"\n        srcset=\"/static/8de795e097623b8d278ca45ee3184480/a80bd/tcp2.jpg 148w,\n/static/8de795e097623b8d278ca45ee3184480/1c91a/tcp2.jpg 295w,\n/static/8de795e097623b8d278ca45ee3184480/1c72d/tcp2.jpg 590w,\n/static/8de795e097623b8d278ca45ee3184480/9c477/tcp2.jpg 694w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在发送方给接收方发SYN报文的同时，接收方也给发送方发SYN报文，两个人刚上了!</p>\n<p>发完SYN，两者的状态都变为SYN-SENT。</p>\n<p>在各自收到对方的SYN后，两者状态都变为SYN-RCVD。</p>\n<p>接着会回复对应的ACK + SYN，这个报文在对方接收之后，两者状态一起变为ESTABLISHED。</p>\n<p>这就是同时打开情况下的状态变迁。</p>\n<h1 id=\"003-说说-tcp-四次挥手的过程\" style=\"position:relative;\"><a href=\"#003-%E8%AF%B4%E8%AF%B4-tcp-%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B%E7%9A%84%E8%BF%87%E7%A8%8B\" aria-label=\"003 说说 tcp 四次挥手的过程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>003: 说说 TCP 四次挥手的过程</h1>\n<h2 id=\"过程拆解\" style=\"position:relative;\"><a href=\"#%E8%BF%87%E7%A8%8B%E6%8B%86%E8%A7%A3\" aria-label=\"过程拆解 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>过程拆解</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 553px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1f6a5e17b34f00d28722428b7b8ccb11/a8a10/tcp-4-way-termination.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 86.48648648648648%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3UoAoQH/xAAXEAADAQAAAAAAAAAAAAAAAAABECBB/9oACAEBAAEFAq0r/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAFBABAAAAAAAAAAAAAAAAAAAAMP/aAAgBAQAGPwIf/8QAGxAAAQQDAAAAAAAAAAAAAAAAAAEQESAxQYH/2gAIAQEAAT8h60m6MBD/2gAMAwEAAgADAAAAELAHAP/EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QH//EAB4QAQACAgEFAAAAAAAAAAAAAAEAESExQWGBscHh/9oACAEBAAE/EEbuxntFQ2ueJ0LEums+4lBZes7ii/IeU2zlP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tcp-4-way-termination\"\n        title=\"tcp-4-way-termination\"\n        src=\"/static/1f6a5e17b34f00d28722428b7b8ccb11/a8a10/tcp-4-way-termination.jpg\"\n        srcset=\"/static/1f6a5e17b34f00d28722428b7b8ccb11/a80bd/tcp-4-way-termination.jpg 148w,\n/static/1f6a5e17b34f00d28722428b7b8ccb11/1c91a/tcp-4-way-termination.jpg 295w,\n/static/1f6a5e17b34f00d28722428b7b8ccb11/a8a10/tcp-4-way-termination.jpg 553w\"\n        sizes=\"(max-width: 553px) 100vw, 553px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>刚开始双方处于<code class=\"language-text\">ESTABLISHED</code>状态。</p>\n<p>客户端要断开了，向服务器发送 <code class=\"language-text\">FIN</code> 报文，在 TCP 报文中的位置如下图:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6fc2f9a4b1bd7846f6be02db2171ee1b/eea4a/packet-structure.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHbgi4r/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAGBAAAgMAAAAAAAAAAAAAAAAAAAEQMaH/2gAIAQEAAT8hdmx//9oADAMBAAIAAwAAABD7z//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABURAQEAAAAAAAAAAAAAAAAAABBB/9oACAECAQE/EKf/xAAZEAADAQEBAAAAAAAAAAAAAAAAARFBMWH/2gAIAQEAAT8QpNjnUVTW9YpNP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tcp-ip-packet-structure\"\n        title=\"tcp-ip-packet-structure\"\n        src=\"/static/6fc2f9a4b1bd7846f6be02db2171ee1b/1c72d/packet-structure.jpg\"\n        srcset=\"/static/6fc2f9a4b1bd7846f6be02db2171ee1b/a80bd/packet-structure.jpg 148w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/1c91a/packet-structure.jpg 295w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/1c72d/packet-structure.jpg 590w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/a8a14/packet-structure.jpg 885w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/fbd2c/packet-structure.jpg 1180w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/eea4a/packet-structure.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>发送后客户端变成了<code class=\"language-text\">FIN-WAIT-1</code>状态。注意, 这时候客户端同时也变成了<code class=\"language-text\">half-close(半关闭)</code>状态，即无法向服务端发送报文，只能接收。</p>\n<p>服务端接收后向客户端确认，变成了<code class=\"language-text\">CLOSED-WAIT</code>状态。</p>\n<p>客户端接收到了服务端的确认，变成了<code class=\"language-text\">FIN-WAIT2</code>状态。</p>\n<p>随后，服务端向客户端发送<code class=\"language-text\">FIN</code>，自己进入<code class=\"language-text\">LAST-ACK</code>状态，</p>\n<p>客户端收到服务端发来的FIN后，自己变成了<code class=\"language-text\">TIME-WAIT</code>状态，然后发送<code class=\"language-text\">ACK</code>给服务端。</p>\n<p>注意了，这个时候，客户端需要等待足够长的时间，具体来说，是 2 个 MSL(Maximum Segment Lifetime，报文最大生存时间), 在这段时间内如果客户端没有收到服务端的重发请求，那么表示 ACK 成功到达，挥手结束，否则客户端重发 ACK。</p>\n<h2 id=\"等待2msl的意义\" style=\"position:relative;\"><a href=\"#%E7%AD%89%E5%BE%852msl%E7%9A%84%E6%84%8F%E4%B9%89\" aria-label=\"等待2msl的意义 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>等待2MSL的意义</h2>\n<p>如果不等待会怎样？</p>\n<p>如果不等待，客户端直接跑路，当服务端还有很多数据包要给客户端发，且还在路上的时候，若客户端的端口此时刚好被新的应用占用，那么就接收到了无用数据包，造成数据包混乱。所以，最保险的做法是等服务器发来的数据包都死翘翘再启动新的应用。</p>\n<p>那，照这样说一个 MSL 不就不够了吗，为什么要等待 2 MSL?</p>\n<ul>\n<li>1 个 MSL 确保四次挥手中主动关闭方最后的 ACK 报文最终能达到对端</li>\n<li>1 个 MSL 确保对端没有收到 ACK 重传的 FIN 报文可以到达</li>\n</ul>\n<p>这就是等待 2MSL 的意义。</p>\n<h2 id=\"同时关闭会怎样？\" style=\"position:relative;\"><a href=\"#%E5%90%8C%E6%97%B6%E5%85%B3%E9%97%AD%E4%BC%9A%E6%80%8E%E6%A0%B7%EF%BC%9F\" aria-label=\"同时关闭会怎样？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>同时关闭会怎样？</h2>\n<p>如果客户端和服务端同时发送 FIN ，状态会如何变化？如图所示:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dacafa701b2a7552a866d47a115a0c8c/9aaa0/tcp-termination-simultaneously.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 91.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe6lAGgyD//EABYQAAMAAAAAAAAAAAAAAAAAAAARMP/aAAgBAQABBQIcP//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BH//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BH//EABQQAQAAAAAAAAAAAAAAAAAAADD/2gAIAQEABj8CH//EABwQAAIBBQEAAAAAAAAAAAAAAAABQRARITGBUf/aAAgBAQABPyGZMtC6b9LORdJHT//aAAwDAQACAAMAAAAQcwgA/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHhABAAICAwADAAAAAAAAAAAAAQARITFRYXFBkaH/2gAIAQEAAT8QtG5Z1U7FXuJrf0jkh8uZQjR8iw9uYH7mh7AxP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tcp-termination-simultaneously\"\n        title=\"tcp-termination-simultaneously\"\n        src=\"/static/dacafa701b2a7552a866d47a115a0c8c/1c72d/tcp-termination-simultaneously.jpg\"\n        srcset=\"/static/dacafa701b2a7552a866d47a115a0c8c/a80bd/tcp-termination-simultaneously.jpg 148w,\n/static/dacafa701b2a7552a866d47a115a0c8c/1c91a/tcp-termination-simultaneously.jpg 295w,\n/static/dacafa701b2a7552a866d47a115a0c8c/1c72d/tcp-termination-simultaneously.jpg 590w,\n/static/dacafa701b2a7552a866d47a115a0c8c/9aaa0/tcp-termination-simultaneously.jpg 671w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"004-说说半连接队列和-syn-flood-攻击的关系\" style=\"position:relative;\"><a href=\"#004-%E8%AF%B4%E8%AF%B4%E5%8D%8A%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97%E5%92%8C-syn-flood-%E6%94%BB%E5%87%BB%E7%9A%84%E5%85%B3%E7%B3%BB\" aria-label=\"004 说说半连接队列和 syn flood 攻击的关系 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>004: 说说半连接队列和 SYN Flood 攻击的关系</h1>\n<p>三次握手前，服务端的状态从<code class=\"language-text\">CLOSED</code>变为<code class=\"language-text\">LISTEN</code>, 同时在内部创建了两个队列：<strong>半连接队列</strong>和<strong>全连接队列</strong>，即<strong>SYN队列</strong>和<strong>ACCEPT队列</strong>。</p>\n<h2 id=\"半连接队列\" style=\"position:relative;\"><a href=\"#%E5%8D%8A%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97\" aria-label=\"半连接队列 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>半连接队列</h2>\n<p>当客户端发送<code class=\"language-text\">SYN</code>到服务端，服务端收到以后回复<code class=\"language-text\">ACK</code>和<code class=\"language-text\">SYN</code>，状态由<code class=\"language-text\">LISTEN</code>变为<code class=\"language-text\">SYN_RCVD</code>，此时这个连接就被推入了<code class=\"language-text\">SYN</code>队列，也就是<strong>半连接队列</strong>。</p>\n<h2 id=\"全连接队列\" style=\"position:relative;\"><a href=\"#%E5%85%A8%E8%BF%9E%E6%8E%A5%E9%98%9F%E5%88%97\" aria-label=\"全连接队列 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>全连接队列</h2>\n<p>当客户端返回<code class=\"language-text\">ACK</code>, 服务端接收后，三次握手完成。这个时候连接等待被具体的应用取走，在被取走之前，它会被推入另外一个 TCP 维护的队列，也就是全连接队列(Accept Queue)。</p>\n<h2 id=\"syn-flood-攻击原理\" style=\"position:relative;\"><a href=\"#syn-flood-%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86\" aria-label=\"syn flood 攻击原理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SYN Flood 攻击原理</h2>\n<p>SYN Flood 属于典型的 DoS/DDoS 攻击。其攻击的原理很简单，就是用客户端在短时间内伪造大量不存在的 IP 地址，并向服务端疯狂发送SYN。对于服务端而言，会产生两个危险的后果:</p>\n<ol>\n<li>处理大量的SYN包并返回对应ACK, 势必有大量连接处于SYN_RCVD状态，从而占满整个半连接队列，无法处理正常的请求。</li>\n<li>由于是不存在的 IP，服务端长时间收不到客户端的ACK，会导致服务端不断重发数据，直到耗尽服务端的资源。</li>\n</ol>\n<h2 id=\"如何应对-syn-flood-攻击？\" style=\"position:relative;\"><a href=\"#%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9-syn-flood-%E6%94%BB%E5%87%BB%EF%BC%9F\" aria-label=\"如何应对 syn flood 攻击？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>如何应对 SYN Flood 攻击？</h2>\n<ol>\n<li>增加 SYN 连接，也就是增加半连接队列的容量。</li>\n<li>减少 SYN + ACK 重试次数，避免大量的超时重发。</li>\n<li>利用 SYN Cookie 技术，在服务端接收到SYN后不立即分配连接资源，而是根据这个SYN计算出一个Cookie，连同第二次握手回复给客户端，在客户端回复ACK的时候带上这个Cookie值，服务端验证 Cookie 合法之后才分配连接资源。</li>\n</ol>\n<h1 id=\"005-介绍一下-tcp-报文头部的字段\" style=\"position:relative;\"><a href=\"#005-%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8B-tcp-%E6%8A%A5%E6%96%87%E5%A4%B4%E9%83%A8%E7%9A%84%E5%AD%97%E6%AE%B5\" aria-label=\"005 介绍一下 tcp 报文头部的字段 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>005: 介绍一下 TCP 报文头部的字段</h1>\n<p>报文头部结构如下(单位为字节):</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6fc2f9a4b1bd7846f6be02db2171ee1b/eea4a/packet-structure.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 28.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAGABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHbgi4r/8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQABBQJ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAGBAAAgMAAAAAAAAAAAAAAAAAAAEQMaH/2gAIAQEAAT8hdmx//9oADAMBAAIAAwAAABD7z//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABURAQEAAAAAAAAAAAAAAAAAABBB/9oACAECAQE/EKf/xAAZEAADAQEBAAAAAAAAAAAAAAAAARFBMWH/2gAIAQEAAT8QpNjnUVTW9YpNP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"segment-structure\"\n        title=\"segment-structure\"\n        src=\"/static/6fc2f9a4b1bd7846f6be02db2171ee1b/1c72d/packet-structure.jpg\"\n        srcset=\"/static/6fc2f9a4b1bd7846f6be02db2171ee1b/a80bd/packet-structure.jpg 148w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/1c91a/packet-structure.jpg 295w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/1c72d/packet-structure.jpg 590w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/a8a14/packet-structure.jpg 885w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/fbd2c/packet-structure.jpg 1180w,\n/static/6fc2f9a4b1bd7846f6be02db2171ee1b/eea4a/packet-structure.jpg 1280w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>请大家牢记这张图！</p>\n<h2 id=\"源端口、目标端口\" style=\"position:relative;\"><a href=\"#%E6%BA%90%E7%AB%AF%E5%8F%A3%E3%80%81%E7%9B%AE%E6%A0%87%E7%AB%AF%E5%8F%A3\" aria-label=\"源端口、目标端口 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>源端口、目标端口</h2>\n<p>如何标识唯一标识一个连接？答案是 TCP 连接的四元组——源 IP、源端口、目标 IP 和目标端口。</p>\n<p>那 TCP 报文怎么没有源 IP 和目标 IP 呢？这是因为在 IP 层就已经处理了 IP 。TCP 只需要记录两者的端口即可。</p>\n<h2 id=\"序列号\" style=\"position:relative;\"><a href=\"#%E5%BA%8F%E5%88%97%E5%8F%B7\" aria-label=\"序列号 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>序列号</h2>\n<p>即Sequence number, 指的是本报文段第一个字节的序列号。</p>\n<p>从图中可以看出，序列号是一个长为 4 个字节，也就是 32 位的无符号整数，表示范围为 0 ~ 2^32 - 1。如果到达最大值了后就循环到0。</p>\n<p>序列号在 TCP 通信的过程中有两个作用:</p>\n<ol>\n<li>在 SYN 报文中交换彼此的初始序列号。</li>\n<li>保证数据包按正确的顺序组装。</li>\n</ol>\n<h2 id=\"isn\" style=\"position:relative;\"><a href=\"#isn\" aria-label=\"isn permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ISN</h2>\n<p>即Initial Sequence Number（初始序列号）,在三次握手的过程当中，双方会用过SYN报文来交换彼此的 ISN。</p>\n<p>ISN 并不是一个固定的值，而是每 4 ms 加一，溢出则回到 0，这个算法使得猜测 ISN 变得很困难。那为什么要这么做？</p>\n<p>如果 ISN 被攻击者预测到，要知道源 IP 和源端口号都是很容易伪造的，当攻击者猜测 ISN 之后，直接伪造一个 RST 后，就可以强制连接关闭的，这是非常危险的。</p>\n<p>而动态增长的 ISN 大大提高了猜测 ISN 的难度。</p>\n<h2 id=\"确认号\" style=\"position:relative;\"><a href=\"#%E7%A1%AE%E8%AE%A4%E5%8F%B7\" aria-label=\"确认号 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>确认号</h2>\n<p>即ACK(Acknowledgment number)。用来告知对方下一个期望接收的序列号，小于ACK的所有字节已经全部收到。</p>\n<h2 id=\"标记位\" style=\"position:relative;\"><a href=\"#%E6%A0%87%E8%AE%B0%E4%BD%8D\" aria-label=\"标记位 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>标记位</h2>\n<p>常见的标记位有SYN,ACK,FIN,RST,PSH。</p>\n<p>SYN 和 ACK 已经在上文说过，后三个解释如下: FIN： 即 Finish，表示发送方准备断开连接。</p>\n<p>RST：即 Reset，用来强制断开连接。</p>\n<p>PSH： 即 Push, 告知对方这些数据包收到后应该马上交给上层的应用，不能缓存。</p>\n<h2 id=\"窗口大小\" style=\"position:relative;\"><a href=\"#%E7%AA%97%E5%8F%A3%E5%A4%A7%E5%B0%8F\" aria-label=\"窗口大小 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>窗口大小</h2>\n<p>占用两个字节，也就是 16 位，但实际上是不够用的。因此 TCP 引入了窗口缩放的选项，作为窗口缩放的比例因子，这个比例因子的范围在 0 ~ 14，比例因子可以将窗口的值扩大为原来的 2 ^ n 次方。</p>\n<h2 id=\"校验和\" style=\"position:relative;\"><a href=\"#%E6%A0%A1%E9%AA%8C%E5%92%8C\" aria-label=\"校验和 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>校验和</h2>\n<p>占用两个字节，防止传输过程中数据包有损坏，如果遇到校验和有差错的报文，TCP 直接丢弃之，等待重传。</p>\n<h2 id=\"可选项\" style=\"position:relative;\"><a href=\"#%E5%8F%AF%E9%80%89%E9%A1%B9\" aria-label=\"可选项 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>可选项</h2>\n<p>可选项的格式如下:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3a676ec2fba362873a33bbd0c3bf94cc/b4708/tcp-options.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.162162162162163%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAACABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHbgSwX/8QAFRABAQAAAAAAAAAAAAAAAAAAEEH/2gAIAQEAAQUCp//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAABD/2gAIAQEABj8Cf//EABYQAQEBAAAAAAAAAAAAAAAAAAABMf/aAAgBAQABPyEiY//aAAwDAQACAAMAAAAQdA//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAXEAADAQAAAAAAAAAAAAAAAAAAAREh/9oACAEBAAE/EK60dx6Pg//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tcp-options\"\n        title=\"tcp-options\"\n        src=\"/static/3a676ec2fba362873a33bbd0c3bf94cc/1c72d/tcp-options.jpg\"\n        srcset=\"/static/3a676ec2fba362873a33bbd0c3bf94cc/a80bd/tcp-options.jpg 148w,\n/static/3a676ec2fba362873a33bbd0c3bf94cc/1c91a/tcp-options.jpg 295w,\n/static/3a676ec2fba362873a33bbd0c3bf94cc/1c72d/tcp-options.jpg 590w,\n/static/3a676ec2fba362873a33bbd0c3bf94cc/b4708/tcp-options.jpg 862w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>常用的可选项有以下几个:</p>\n<ul>\n<li>TimeStamp: TCP 时间戳，后面详细介绍。</li>\n<li>MSS: 指的是 TCP 允许的从对方接收的最大报文段。</li>\n<li>SACK: 选择确认选项。</li>\n<li>Window Scale： 窗口缩放选项。</li>\n</ul>\n<h1 id=\"006-说说-tcp-快速打开的原理tfo\" style=\"position:relative;\"><a href=\"#006-%E8%AF%B4%E8%AF%B4-tcp-%E5%BF%AB%E9%80%9F%E6%89%93%E5%BC%80%E7%9A%84%E5%8E%9F%E7%90%86tfo\" aria-label=\"006 说说 tcp 快速打开的原理tfo permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>006: 说说 TCP 快速打开的原理(TFO)</h1>\n<p>第一节讲了 TCP 三次握手，可能有人会说，每次都三次握手好麻烦呀！能不能优化一点？</p>\n<p>可以啊。今天来说说这个优化后的 TCP 握手流程，也就是 TCP 快速打开(TCP Fast Open, 即TFO)的原理。</p>\n<p>优化的过程是这样的，还记得我们说 SYN Flood 攻击时提到的 SYN Cookie 吗？这个 Cookie 可不是浏览器的Cookie, 用它同样可以实现 TFO。</p>\n<h2 id=\"tfo-流程\" style=\"position:relative;\"><a href=\"#tfo-%E6%B5%81%E7%A8%8B\" aria-label=\"tfo 流程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TFO 流程</h2>\n<h3 id=\"首轮三次握手\" style=\"position:relative;\"><a href=\"#%E9%A6%96%E8%BD%AE%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B\" aria-label=\"首轮三次握手 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>首轮三次握手</h3>\n<p>首先客户端发送SYN给服务端，服务端接收到。</p>\n<p>注意哦！现在服务端不是立刻回复 SYN + ACK，而是通过计算得到一个SYN Cookie, 将这个Cookie放到 TCP 报文的 Fast Open选项中，然后才给客户端返回。</p>\n<p>客户端拿到这个 Cookie 的值缓存下来。后面正常完成三次握手。</p>\n<p>首轮三次握手就是这样的流程。而后面的三次握手就不一样啦！</p>\n<h3 id=\"后面的三次握手\" style=\"position:relative;\"><a href=\"#%E5%90%8E%E9%9D%A2%E7%9A%84%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B\" aria-label=\"后面的三次握手 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>后面的三次握手</h3>\n<p>在后面的三次握手中，客户端会将之前缓存的 Cookie、SYN 和HTTP请求(是的，你没看错)发送给服务端，服务端验证了 Cookie 的合法性，如果不合法直接丢弃；如果是合法的，那么就正常返回SYN + ACK。</p>\n<p>重点来了，现在服务端能向客户端发 HTTP 响应了！这是最显著的改变，三次握手还没建立，仅仅验证了 Cookie 的合法性，就可以返回 HTTP 响应了。</p>\n<p>当然，客户端的ACK还得正常传过来，不然怎么叫三次握手嘛。</p>\n<p>流程如下:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1deec214d34cde3ff025ca44cb5e94e6/054c0/tcp-tfo.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 88.51351351351352%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAASABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe8kNoKAD//EABcQAQADAAAAAAAAAAAAAAAAABABESD/2gAIAQEAAQUCZKx//8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPwEf/8QAFBABAAAAAAAAAAAAAAAAAAAAMP/aAAgBAQAGPwIf/8QAGhAAAgIDAAAAAAAAAAAAAAAAABEBIRAxQf/aAAgBAQABPyG3QyDYUCHScf/aAAwDAQACAAMAAAAQsMA8/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPxAf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAgEBPxAf/8QAHxAAAgICAQUAAAAAAAAAAAAAAREAITFREEFhcYHB/9oACAEBAAE/ECiaO4ToEK+lwgsn3AY5xpxoAbZsGdufMDHnj//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"tcp-tfo\"\n        title=\"tcp-tfo\"\n        src=\"/static/1deec214d34cde3ff025ca44cb5e94e6/1c72d/tcp-tfo.jpg\"\n        srcset=\"/static/1deec214d34cde3ff025ca44cb5e94e6/a80bd/tcp-tfo.jpg 148w,\n/static/1deec214d34cde3ff025ca44cb5e94e6/1c91a/tcp-tfo.jpg 295w,\n/static/1deec214d34cde3ff025ca44cb5e94e6/1c72d/tcp-tfo.jpg 590w,\n/static/1deec214d34cde3ff025ca44cb5e94e6/054c0/tcp-tfo.jpg 633w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>注意: 客户端最后握手的 ACK 不一定要等到服务端的 HTTP 响应到达才发送，两个过程没有任何关系。</p>\n<h3 id=\"tfo-的优势\" style=\"position:relative;\"><a href=\"#tfo-%E7%9A%84%E4%BC%98%E5%8A%BF\" aria-label=\"tfo 的优势 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TFO 的优势</h3>\n<p>TFO 的优势并不在与首轮三次握手，而在于后面的握手，在拿到客户端的 Cookie 并验证通过以后，可以直接返回 HTTP 响应，充分利用了1 个RTT(Round-Trip Time，往返时延)的时间提前进行数据传输，积累起来还是一个比较大的优势。</p>\n<h1 id=\"007-能不能说说tcp报文中时间戳的作用？\" style=\"position:relative;\"><a href=\"#007-%E8%83%BD%E4%B8%8D%E8%83%BD%E8%AF%B4%E8%AF%B4tcp%E6%8A%A5%E6%96%87%E4%B8%AD%E6%97%B6%E9%97%B4%E6%88%B3%E7%9A%84%E4%BD%9C%E7%94%A8%EF%BC%9F\" aria-label=\"007 能不能说说tcp报文中时间戳的作用？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>007: 能不能说说TCP报文中时间戳的作用？</h1>\n<p><code class=\"language-text\">timestamp</code>是 TCP 报文首部的一个可选项，一共占 10 个字节，格式如下:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">kind(1 字节) + length(1 字节) + info(8 个字节)</code></pre></div>\n<p>其中 kind = 8， length = 10， info 有两部分构成: timestamp和timestamp echo，各占 4 个字节。</p>\n<p>那么这些字段都是干嘛的呢？它们用来解决那些问题？</p>\n<p>接下来我们就来一一梳理，TCP 的时间戳主要解决两大问题:</p>\n<ul>\n<li>计算往返时延 RTT(Round-Trip Time)</li>\n<li>防止序列号的回绕问题</li>\n</ul>\n<h2 id=\"计算往返时延-rtt\" style=\"position:relative;\"><a href=\"#%E8%AE%A1%E7%AE%97%E5%BE%80%E8%BF%94%E6%97%B6%E5%BB%B6-rtt\" aria-label=\"计算往返时延 rtt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>计算往返时延 RTT</h2>\n<p>在没有时间戳的时候，计算 RTT 会遇到的问题如下图所示:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 383px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/259cd8070a98875f15bc2abc2fad9c64/411a4/rtt.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAe5tCVD/xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAEFAl//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAACAwEAAAAAAAAAAAAAAAAAAREgMSH/2gAIAQEAAT8hljnmm0//2gAMAwEAAgADAAAAENAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGxABAAIDAQEAAAAAAAAAAAAAAQAhETFBUXH/2gAIAQEAAT8Qsd2tbiww4zkgtmn6kOzyO5//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"rtt\"\n        title=\"rtt\"\n        src=\"/static/259cd8070a98875f15bc2abc2fad9c64/411a4/rtt.jpg\"\n        srcset=\"/static/259cd8070a98875f15bc2abc2fad9c64/a80bd/rtt.jpg 148w,\n/static/259cd8070a98875f15bc2abc2fad9c64/1c91a/rtt.jpg 295w,\n/static/259cd8070a98875f15bc2abc2fad9c64/411a4/rtt.jpg 383w\"\n        sizes=\"(max-width: 383px) 100vw, 383px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>如果以第一次发包为开始时间的话，就会出现左图的问题，RTT 明显偏大，开始时间应该采用第二次的；</p>\n<p>如果以第二次发包为开始时间的话，就会导致右图的问题，RTT 明显偏小，开始时间应该采用第一次发包的。</p>\n<p>实际上无论开始时间以第一次发包还是第二次发包为准，都是不准确的。</p>\n<p>那这个时候引入时间戳就很好的解决了这个问题。</p>\n<p>比如现在 a 向 b 发送一个报文 s1，b 向 a 回复一个含 ACK 的报文 s2 那么：</p>\n<ul>\n<li>step 1: a 向 b 发送的时候，timestamp 中存放的内容就是 a 主机发送时的内核时刻 ta1。</li>\n<li>step 2: b 向 a 回复 s2 报文的时候，timestamp 中存放的是 b 主机的时刻 tb, timestamp echo字段为从 s1 报文中解析出来的 ta1。</li>\n<li>step 3: a 收到 b 的 s2 报文之后，此时 a 主机的内核时刻是 ta2, 而在 s2 报文中的 timestamp echo 选项中可以得到 ta1, 也就是 s2 对应的报文最初的发送时刻。然后直接采用 ta2 - ta1 就得到了 RTT 的值。</li>\n</ul>\n<h2 id=\"防止序列号回绕问题\" style=\"position:relative;\"><a href=\"#%E9%98%B2%E6%AD%A2%E5%BA%8F%E5%88%97%E5%8F%B7%E5%9B%9E%E7%BB%95%E9%97%AE%E9%A2%98\" aria-label=\"防止序列号回绕问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>防止序列号回绕问题</h2>\n<p>现在我们来模拟一下这个问题。</p>\n<p>序列号的范围其实是在0 ~ 2 ^ 32 - 1, 为了方便演示，我们缩小一下这个区间，假设范围是 0 ~ 4，那么到达 4 的时候会回到 0。</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\">第几次发包</th>\n<th align=\"center\">发送字节</th>\n<th align=\"center\">对应序列号</th>\n<th align=\"center\">状态</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td align=\"center\">1</td>\n<td align=\"center\">0 ~ 1</td>\n<td align=\"center\">0 ~ 1</td>\n<td align=\"center\">成功接收</td>\n</tr>\n<tr>\n<td align=\"center\">2</td>\n<td align=\"center\">1 ~ 2</td>\n<td align=\"center\">1 ~ 2</td>\n<td align=\"center\">滞留在网络中</td>\n</tr>\n<tr>\n<td align=\"center\">3</td>\n<td align=\"center\">2 ~ 3</td>\n<td align=\"center\">2 ~ 3</td>\n<td align=\"center\">成功接收</td>\n</tr>\n<tr>\n<td align=\"center\">4</td>\n<td align=\"center\">3 ~ 4</td>\n<td align=\"center\">3 ~ 4</td>\n<td align=\"center\">成功接收</td>\n</tr>\n<tr>\n<td align=\"center\">5</td>\n<td align=\"center\">4 ~ 5</td>\n<td align=\"center\">0 ~ 1</td>\n<td align=\"center\">成功接收，序列号从0开始</td>\n</tr>\n<tr>\n<td align=\"center\">6</td>\n<td align=\"center\">5 ~ 6</td>\n<td align=\"center\">1 ~ 2</td>\n<td align=\"center\">？？？</td>\n</tr>\n</tbody>\n</table>\n<p>假设在第 6 次的时候，之前还滞留在网路中的包回来了，那么就有两个序列号为1 ~ 2的数据包了，怎么区分谁是谁呢？这个时候就产生了序列号回绕的问题。</p>\n<p>那么用 timestamp 就能很好地解决这个问题，因为每次发包的时候都是将发包机器当时的内核时间记录在报文中，那么两次发包序列号即使相同，时间戳也不可能相同，这样就能够区分开两个数据包了。</p>\n<h1 id=\"008-tcp-的超时重传时间是如何计算的？\" style=\"position:relative;\"><a href=\"#008-tcp-%E7%9A%84%E8%B6%85%E6%97%B6%E9%87%8D%E4%BC%A0%E6%97%B6%E9%97%B4%E6%98%AF%E5%A6%82%E4%BD%95%E8%AE%A1%E7%AE%97%E7%9A%84%EF%BC%9F\" aria-label=\"008 tcp 的超时重传时间是如何计算的？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>008: TCP 的超时重传时间是如何计算的？</h1>\n<p>TCP 具有超时重传机制，即间隔一段时间没有等到数据包的回复时，重传这个数据包。</p>\n<p>那么这个重传间隔是如何来计算的呢？</p>\n<p>今天我们就来讨论一下这个问题。</p>\n<p>这个重传间隔也叫做<strong>超时重传时间(Retransmission TimeOut, 简称RTO)</strong>，它的计算跟上一节提到的 RTT 密切相关。这里我们将介绍两种主要的方法，一个是经典方法，一个是标准方法。</p>\n<h2 id=\"经典方法\" style=\"position:relative;\"><a href=\"#%E7%BB%8F%E5%85%B8%E6%96%B9%E6%B3%95\" aria-label=\"经典方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>经典方法</h2>\n<p>经典方法引入了一个新的概念——SRTT(Smoothed round trip time，即平滑往返时间)，没产生一次新的 RTT. 就根据一定的算法对 SRTT 进行更新，具体而言，计算方式如下(SRTT 初始值为0):</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\">SRTT <span class=\"token operator\">=</span>  <span class=\"token punctuation\">(</span>α <span class=\"token operator\">*</span> SRTT<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> α<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> RTT<span class=\"token punctuation\">)</span></code></pre></div>\n<p>其中，α 是<strong>平滑因子</strong>，建议值是0.8，范围是0.8 ~ 0.9。</p>\n<p>拿到 SRTT，我们就可以计算 RTO 的值了:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\">RTO <span class=\"token operator\">=</span> <span class=\"token builtin\">min</span><span class=\"token punctuation\">(</span>ubound<span class=\"token punctuation\">,</span> <span class=\"token builtin\">max</span><span class=\"token punctuation\">(</span>lbound<span class=\"token punctuation\">,</span> β <span class=\"token operator\">*</span> SRTT<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>β 是加权因子，一般为1.3 ~ 2.0， lbound 是下界，ubound 是上界。</p>\n<p>其实这个算法过程还是很简单的，但是也存在一定的局限，就是在 RTT 稳定的地方表现还可以，而在 RTT 变化较大的地方就不行了，因为平滑因子 α 的范围是0.8 ~ 0.9, RTT 对于 RTO 的影响太小。</p>\n<h2 id=\"标准方法\" style=\"position:relative;\"><a href=\"#%E6%A0%87%E5%87%86%E6%96%B9%E6%B3%95\" aria-label=\"标准方法 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>标准方法</h2>\n<p>为了解决经典方法对于 RTT 变化不敏感的问题，后面又引出了标准方法，也叫<code class=\"language-text\">Jacobson / Karels</code>算法。</p>\n<p>一共有三步。</p>\n<p>第一步: 计算SRTT，公式如下:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\">SRTT <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> α<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> SRTT <span class=\"token operator\">+</span> α <span class=\"token operator\">*</span> RTT</code></pre></div>\n<p>注意这个时候的 α跟经典方法中的α取值不一样了，建议值是1/8，也就是0.125。</p>\n<p>第二步: 计算RTTVAR(round-trip time variation)这个中间变量。</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\">RTTVAR <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> β<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> RTTVAR <span class=\"token operator\">+</span> β <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">|</span>RTT <span class=\"token operator\">-</span> SRTT<span class=\"token operator\">|</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>β 建议值为 0.25。这个值是这个算法中出彩的地方，也就是说，它记录了最新的 RTT 与当前 SRTT 之间的差值，给我们在后续感知到 RTT 的变化提供了抓手。</p>\n<p>第三步: 计算最终的RTO:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\">RTO <span class=\"token operator\">=</span> µ <span class=\"token operator\">*</span> SRTT <span class=\"token operator\">+</span> ∂ <span class=\"token operator\">*</span> RTTVAR </code></pre></div>\n<p>µ建议值取1, ∂建议值取4。</p>\n<p>这个公式在 SRTT 的基础上加上了最新 RTT 与它的偏移，从而很好的感知了 RTT 的变化，这种算法下，RTO 与 RTT 变化的差值关系更加密切。</p>\n<h1 id=\"009-能不能说一说-tcp-的流量控制？\" style=\"position:relative;\"><a href=\"#009-%E8%83%BD%E4%B8%8D%E8%83%BD%E8%AF%B4%E4%B8%80%E8%AF%B4-tcp-%E7%9A%84%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%EF%BC%9F\" aria-label=\"009 能不能说一说 tcp 的流量控制？ permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>009: 能不能说一说 TCP 的流量控制？</h1>\n<p>对于发送端和接收端而言，TCP 需要把发送的数据放到发送缓存区, 将接收的数据放到接收缓存区。</p>\n<p>而流量控制索要做的事情，就是在通过接收缓存区的大小，控制发送端的发送。如果对方的接收缓存区满了，就不能再继续发送了。</p>\n<p>要具体理解流量控制，首先需要了解滑动窗口的概念。</p>\n<h2 id=\"tcp-滑动窗口\" style=\"position:relative;\"><a href=\"#tcp-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3\" aria-label=\"tcp 滑动窗口 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TCP 滑动窗口</h2>\n<p>TCP 滑动窗口分为两种: 发送窗口和接收窗口。</p>\n<h3 id=\"发送窗口\" style=\"position:relative;\"><a href=\"#%E5%8F%91%E9%80%81%E7%AA%97%E5%8F%A3\" aria-label=\"发送窗口 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>发送窗口</h3>\n<p>发送端的滑动窗口结构如下:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1d9e8147d3de5957ccf7984247df3aa0/39048/send-window.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.324324324324326%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAFABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAdwJQX//xAAXEAEBAQEAAAAAAAAAAAAAAAABABEh/9oACAEBAAEFAsbGOH//xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPwGH/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxABAQEBAAAAAAAAAAAAAAAAADERMv/aAAgBAQAGPwLpV1//xAAaEAACAgMAAAAAAAAAAAAAAAAAEQGRIUFx/9oACAEBAAE/IWPKjQ9EZRPQ/9oADAMBAAIAAwAAABB0D//EABYRAQEBAAAAAAAAAAAAAAAAAAEQEf/aAAgBAwEBPxAA7P/EABYRAQEBAAAAAAAAAAAAAAAAABEBEP/aAAgBAgEBPxAYZ//EABsQAQACAgMAAAAAAAAAAAAAAAEAESExQVGx/9oACAEBAAE/EL1qL1TERNp5piCFLsB5P//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"send-window\"\n        title=\"send-window\"\n        src=\"/static/1d9e8147d3de5957ccf7984247df3aa0/1c72d/send-window.jpg\"\n        srcset=\"/static/1d9e8147d3de5957ccf7984247df3aa0/a80bd/send-window.jpg 148w,\n/static/1d9e8147d3de5957ccf7984247df3aa0/1c91a/send-window.jpg 295w,\n/static/1d9e8147d3de5957ccf7984247df3aa0/1c72d/send-window.jpg 590w,\n/static/1d9e8147d3de5957ccf7984247df3aa0/a8a14/send-window.jpg 885w,\n/static/1d9e8147d3de5957ccf7984247df3aa0/39048/send-window.jpg 908w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>其中包含四大部分:</p>\n<ul>\n<li>已发送且已确认</li>\n<li>已发送但未确认</li>\n<li>未发送但可以发送</li>\n<li>未发送也不可以发送</li>\n</ul>\n<p>其中有一些重要的概念，我标注在图中:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/438366a25131c6ababb2a89b8332533c/deea3/send-window-explain.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.189189189189186%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAIABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAIF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB3AFBf//EABcQAAMBAAAAAAAAAAAAAAAAAAARIQH/2gAIAQEAAQUCrpjX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxAAAwEAAAAAAAAAAAAAAAAAABAhMf/aAAgBAQAGPwLFT//EABsQAAICAwEAAAAAAAAAAAAAAAABEZEhQVFh/9oACAEBAAE/IW8ULJ5VmoSfjk//2gAMAwEAAgADAAAAEIwP/8QAFhEBAQEAAAAAAAAAAAAAAAAAAREQ/9oACAEDAQE/EAjbn//EABYRAAMAAAAAAAAAAAAAAAAAABARQf/aAAgBAgEBPxCIf//EABwQAQACAQUAAAAAAAAAAAAAAAEAEUEhcZGh0f/aAAgBAQABPxAaFOHPqKDdyaA/Ils1Q5on/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"send-window-explain\"\n        title=\"send-window-explain\"\n        src=\"/static/438366a25131c6ababb2a89b8332533c/1c72d/send-window-explain.jpg\"\n        srcset=\"/static/438366a25131c6ababb2a89b8332533c/a80bd/send-window-explain.jpg 148w,\n/static/438366a25131c6ababb2a89b8332533c/1c91a/send-window-explain.jpg 295w,\n/static/438366a25131c6ababb2a89b8332533c/1c72d/send-window-explain.jpg 590w,\n/static/438366a25131c6ababb2a89b8332533c/deea3/send-window-explain.jpg 876w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>发送窗口就是图中被框住的范围。SND 即send, WND 即window, UNA 即unacknowledged, 表示未被确认，NXT 即next, 表示下一个发送的位置。</p>\n<h3 id=\"接收窗口\" style=\"position:relative;\"><a href=\"#%E6%8E%A5%E6%94%B6%E7%AA%97%E5%8F%A3\" aria-label=\"接收窗口 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>接收窗口</h3>\n<p>接收端的窗口结构如下:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c574e054158489fa0f8fa1447dbf4e10/f0afc/receive-window.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.2972972972973%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAECAwX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/aAAwDAQACEAMQAAAB21YJRMV//8QAGBAAAwEBAAAAAAAAAAAAAAAAAAERAhD/2gAIAQEAAQUCbduhUff/xAAVEQEBAAAAAAAAAAAAAAAAAAAQEf/aAAgBAwEBPwGH/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAQUBAAAAAAAAAAAAAAAAAAERIDGhIf/aAAgBAQAGPwKtK06jQ//EABsQAAIBBQAAAAAAAAAAAAAAAAABMRARIVFx/9oACAEBAAE/IcFEaFDspnbklX//2gAMAwEAAgADAAAAEFcf/8QAGBEBAQADAAAAAAAAAAAAAAAAEQABsdH/2gAIAQMBAT8QSuuWb//EABYRAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAgEBPxARf//EAB4QAAEEAQUAAAAAAAAAAAAAAAEAESExEFGRobHx/9oACAEBAAE/EDYcoMH4RGHKOnlP8LlCrZdtC8f/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"receive-window\"\n        title=\"receive-window\"\n        src=\"/static/c574e054158489fa0f8fa1447dbf4e10/1c72d/receive-window.jpg\"\n        srcset=\"/static/c574e054158489fa0f8fa1447dbf4e10/a80bd/receive-window.jpg 148w,\n/static/c574e054158489fa0f8fa1447dbf4e10/1c91a/receive-window.jpg 295w,\n/static/c574e054158489fa0f8fa1447dbf4e10/1c72d/receive-window.jpg 590w,\n/static/c574e054158489fa0f8fa1447dbf4e10/f0afc/receive-window.jpg 658w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>REV 即 receive，NXT 表示下一个接收的位置，WND 表示接收窗口大小。</p>\n<h3 id=\"流量控制过程\" style=\"position:relative;\"><a href=\"#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6%E8%BF%87%E7%A8%8B\" aria-label=\"流量控制过程 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>流量控制过程</h3>\n<p>这里我们不用太复杂的例子，以一个最简单的来回来模拟一下流量控制的过程，方便大家理解。</p>\n<p>首先双方三次握手，初始化各自的窗口大小，均为 200 个字节。</p>\n<p>假如当前发送端给接收端发送 100 个字节，那么此时对于发送端而言，SND.NXT 当然要右移 100 个字节，也就是说当前的可用窗口减少了 100 个字节，这很好理解。</p>\n<p>现在这 100 个到达了接收端，被放到接收端的缓冲队列中。不过此时由于大量负载的原因，接收端处理不了这么多字节，只能处理 40 个字节，剩下的 60 个字节被留在了缓冲队列中。</p>\n<p>注意了，此时接收端的情况是处理能力不够用啦，你发送端给我少发点，所以此时接收端的接收窗口应该缩小，具体来说，缩小 60 个字节，由 200 个字节变成了 140 字节，因为缓冲队列还有 60 个字节没被应用拿走。</p>\n<p>因此，接收端会在 ACK 的报文首部带上缩小后的滑动窗口 140 字节，发送端对应地调整发送窗口的大小为 140 个字节。</p>\n<p>此时对于发送端而言，已经发送且确认的部分增加 40 字节，也就是 SND.UNA 右移 40 个字节，同时发送窗口缩小为 140 个字节。</p>\n<p>这也就是流量控制的过程。尽管回合再多，整个控制的过程和原理是一样的。</p>","frontmatter":{"title":"TCP协议面试前复习","date":"July 06, 2020","description":"转自神三元博客：http://47.98.159.95/my_blog/tcp/001.html 本文对原版有改动"}}},"pageContext":{"slug":"/tcp-review/","previous":{"fields":{"slug":"/k8s1/"},"frontmatter":{"title":"Preparation for the CKA Exam 01"}},"next":null}}}